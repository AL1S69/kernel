name: Chopin Kernel Build (Final Stable)

on:
  workflow_dispatch: # 仅手动触发，避免频繁失败

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }} # 强制使用默认工作目录

    steps:
      - name: 1. System Prep
        run: |
          # 仅清理工作目录内文件，不触碰系统/家目录
          rm -rf ./* 2>/dev/null
          # 安装依赖（最小化+静默）
          sudo apt update -y 2>/dev/null
          sudo apt install -y \
            bc bison build-essential ccache curl flex git libssl-dev \
            libncurses-dev lib32z1-dev liblz4-tool lzop squashfs-tools \
            xsltproc zip zlib1g-dev device-tree-compiler python3 binutils \
            unzip gcc-multilib g++-multilib
          sudo ln -sf /usr/bin/python3 /usr/bin/python

      - name: 2. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: 3. Get AnyKernel3
        uses: actions/checkout@v4
        with:
          repository: osm0sis/AnyKernel3
          path: anykernel3
          ref: master

      - name: 4. Install LLVM 19.1.0
        run: |
          mkdir -p toolchains/llvm
          # 下载+解压（断点续传+静默）
          curl -L --retry 5 -o llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz 2>/dev/null
          tar -xJ -C toolchains/llvm --strip-components=1 -f llvm.tar.xz 2>/dev/null
          rm -f llvm.tar.xz
          # 临时添加工具链到PATH
          echo "$PWD/toolchains/llvm/bin" >> $GITHUB_PATH

      - name: 5. Build Kernel (Clang Only)
        run: |
          # 纯Clang环境配置
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export CXX=clang++
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export KCFLAGS=-Wno-error
          export KBUILD_CFLAGS=-Wno-error

          # 生成默认配置
          make O=out defconfig V=1 2>/dev/null
          [ -f out/.config ] || exit 1

          # 多目标编译兜底
          for TARGET in Image.gz-dtb Image-dtb Image; do
            make -j$(nproc) O=out $TARGET 2>/dev/null && export KERNEL_TARGET=$TARGET && break
          done
          [ -n "$KERNEL_TARGET" ] || exit 1

      - name: 6. Pack Kernel (AB Partition)
        run: |
          # 复制产物到AnyKernel3
          cp out/arch/arm64/boot/$KERNEL_TARGET anykernel3/Image.gz-dtb 2>/dev/null
          # 适配chopin设备
          sed -i -e 's/^device.name1=.*/device.name1=chopin/' -e 's/^is_slot_device=.*/is_slot_device=1/' anykernel3/anykernel.sh
          # 打包
          cd anykernel3 && zip -r9 Chopin-Kernel-$(date +%Y%m%d).zip * -x .git* README.md LICENSE 2>/dev/null
          cp *.zip ../ 2>/dev/null

      - name: 7. Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Chopin-Kernel-Build-Result
          path: |
            *.zip
            out/arch/arm64/boot/*
          retention-days: 7
