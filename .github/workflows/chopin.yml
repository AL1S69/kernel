name: Chopin Kernel Build (Clang Minimal)

on:
  workflow_dispatch:
  push:
    branches: [android-S]
    paths-ignore: ['README.md', '.gitignore', 'docs/**']

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Clean Env
        run: |
          sudo rm -rf ${{ github.workspace }}/* /usr/share/dotnet /opt/ghc
          sudo apt clean -y && apt autoremove -y
          df -h

      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: kernel_src
          submodules: recursive

      - name: Checkout AnyKernel3
        uses: actions/checkout@v4
        with:
          repository: osm0sis/AnyKernel3
          path: anykernel3
          ref: master

      - name: Install Deps
        run: |
          sudo apt update -y 2>/dev/null
          sudo apt install -y bc bison build-essential ccache curl flex git libssl-dev libncurses-dev lib32z1-dev liblz4-tool lzop squashfs-tools xsltproc zip zlib1g-dev device-tree-compiler python3 binutils unzip
          sudo ln -sf /usr/bin/python3 /usr/bin/python

      - name: Python3 Adapt
        run: |
          find ${{ github.workspace }}/kernel_src -name "*.py" -exec sed -i 's/python/python3/' {} \;

      - name: Get LLVM
        run: |
          mkdir -p ${{ github.workspace }}/toolchains/llvm
          curl -L --retry 5 -o ${{ github.workspace }}/llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz
          tar -xJ -C ${{ github.workspace }}/toolchains/llvm --strip-components=1 -f ${{ github.workspace }}/llvm.tar.xz
          [ -f "${{ github.workspace }}/toolchains/llvm/bin/clang" ] || exit 1
          rm -f ${{ github.workspace }}/llvm.tar.xz
          echo "${{ github.workspace }}/toolchains/llvm/bin" >> $GITHUB_PATH

      - name: Config & Build
        run: |
          cd ${{ github.workspace }}/kernel_src
          export ARCH=arm64 SUBARCH=arm64
          export CC=clang CXX=clang++ LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip
          export KCFLAGS=-Wno-error KBUILD_CFLAGS=-Wno-error CLANG_FLAGS=-Wno-error
          make O=out defconfig V=1
          [ -f "out/.config" ] || exit 1
          for TARGET in Image.gz-dtb Image-dtb Image; do
            make -j$(nproc) O=out $TARGET && export KERNEL_TARGET=$TARGET && break
          done
          [ -f "out/arch/arm64/boot/$KERNEL_TARGET" ] || exit 1

      - name: Pack
        run: |
          cp ${{ github.workspace }}/kernel_src/out/arch/arm64/boot/$KERNEL_TARGET ${{ github.workspace }}/anykernel3/Image.gz-dtb
          sed -i -e 's/^device.name1=.*/device.name1=chopin/' -e 's/^is_slot_device=.*/is_slot_device=1/' ${{ github.workspace }}/anykernel3/anykernel.sh
          cd ${{ github.workspace }}/anykernel3
          zip -r9 Chopin-Kernel-$(date +%Y%m%d).zip * -x .git* README.md LICENSE
          cp *.zip ${{ github.workspace }}/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Chopin-Kernel-Build
          path: |
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/kernel_src/out/arch/arm64/boot/*
          retention-days: 7
