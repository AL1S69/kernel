name: Build & Pack Lavender 4.4 Kernel (LLVM19+AnyKernel3-Aonly)
on:
  workflow_dispatch:

jobs:
  build_and_pack:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Install Dependencies (修复权限)
        run: |
          # 跳过apt clean（避免权限错误），仅更新并安装依赖
          sudo apt update -y
          sudo apt install -y --no-install-recommends \
          git make bison flex gcc-aarch64-linux-gnu bc libssl1.1 libelf-dev \
          python3 curl liblz4-tool zstd xz-utils libncurses5-dev patch zip
          # 移除rm /var/lib/apt/lists的操作，避免权限拒绝

      - name: 2. Clone Kernel Source
        run: |
          git clone -b main --depth=1 https://github.com/jsdizkcksv/android_kernel_xiaomi_sdm660.git lavender-44
          cd lavender-44
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          git submodule update --init --depth=1 || true

      - name: 3. Cache LLVM 19.1.0
        id: cache-llvm
        uses: actions/cache@v3
        with:
          path: ./lavender-44/llvm-19.1.0
          key: llvm-19.1.0-lavender44

      - name: 4. Download & Extract LLVM 19.1.0
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cd ${{ env.KERNEL_DIR }}
          wget -q https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz -O llvm.tar.xz
          mkdir -p llvm-19.1.0 && tar -xf llvm.tar.xz -C llvm-19.1.0 --strip-components=1
          rm -f llvm.tar.xz # 仅删除下载的压缩包，无权限问题
          echo "LLVM_DIR=$(pwd)/llvm-19.1.0" >> $GITHUB_ENV
          echo "CLANG_DIR=$(pwd)/llvm-19.1.0/bin" >> $GITHUB_ENV

      - name: 5. Integrate SukiSU-Ultra
        run: |
          cd ${{ env.KERNEL_DIR }}
          curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh | bash -s main
          [ -d KernelSU ] || exit 1
          echo 'EXTRA_CFLAGS += -std=c99 -Wno-gcc-compat -Wno-incompatible-pointer-types' >> drivers/kernelsu/kpm/Makefile
          echo 'EXTRA_CFLAGS += -Wno-implicit-function-declaration -Wno-typedef-redefinition' >> drivers/kernelsu/Makefile

      - name: 6. Configure Kernel (Step-by-Step)
        run: |
          cd ${{ env.KERNEL_DIR }}
          make O=out ARCH=arm64 lavender_defconfig
          echo "CONFIG_BPF=y" >> out/.config
          echo "CONFIG_BPF_SYSCALL=y" >> out/.config
          echo "CONFIG_BPF_JIT=y" >> out/.config
          echo "CONFIG_NET_CLS_BPF=y" >> out/.config
          echo "CONFIG_NET_ACT_BPF=y" >> out/.config
          echo "CONFIG_KALLSYMS=y" >> out/.config
          echo "CONFIG_KALLSYMS_ALL=y" >> out/.config
          echo "CONFIG_KPROBES=y" >> out/.config
          echo "CONFIG_HAVE_KPROBES=y" >> out/.config
          echo "CONFIG_KPROBE_EVENTS=y" >> out/.config
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_KPM=y" >> out/.config
          echo "CONFIG_MODULES=y" >> out/.config
          echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
          echo "CONFIG_DEBUG_INFO_BTF=n" >> out/.config
          echo "CONFIG_CC_STD_C99=n" >> out/.config
          echo "CONFIG_LTO=n" >> out/.config
          yes "" | make O=out ARCH=arm64 olddefconfig
          grep -E "CONFIG_BPF=y|CONFIG_KSU=y" out/.config || { echo "Config Failed" && exit 1; }

      - name: 7. Compile Kernel
        run: |
          cd ${{ env.KERNEL_DIR }}
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=${{ env.CLANG_DIR }}/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export LD=${{ env.CLANG_DIR }}/ld.lld
          export AR=${{ env.CLANG_DIR }}/llvm-ar
          export NM=${{ env.CLANG_DIR }}/llvm-nm
          export OBJCOPY=${{ env.CLANG_DIR }}/llvm-objcopy
          export OBJDUMP=${{ env.CLANG_DIR }}/llvm-objdump
          
          export KBUILD_LTO=none
          export KBUILD_CFLAGS="-Wno-error=unused-command-line-argument -Wno-error=deprecated-declarations"
          export KBUILD_FLAGS="-no-integrated-as"
          export MAKEFLAGS="-j$(nproc)"
          make -j$(nproc) O=out ARCH=arm64 Image dtbo.img dtbs $KBUILD_FLAGS > build.log 2>&1 || { cat build.log && exit 1; }

      - name: 8. Clone AnyKernel3 (A-only)
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel3
          cd anykernel3
          sed -i 's/device.name1=.*/device.name1=lavender/' anykernel.sh
          sed -i 's/block=.*/block=\/dev\/block\/bootdevice\/by-name\/boot/' anykernel.sh
          sed -i 's/is_slot_device=auto/is_slot_device=no/' anykernel.sh
          sed -i 's/skip_dtbo=0/skip_dtbo=1/' anykernel.sh
          echo "ANYKERNEL_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 9. Copy Build Products
        run: |
          cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image ${{ env.ANYKERNEL_DIR }}/zImage
          cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dtbo.img ${{ env.ANYKERNEL_DIR }}/dtbo.img
          cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dts/qcom/sdm660-lavender.dtb ${{ env.ANYKERNEL_
