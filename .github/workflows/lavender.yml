name: Lavender Kernel Build (LLVM 19.1.0 + Skip DTBO)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          path: kernel
          submodules: recursive
          fetch-depth: 0

      - name: Install Basic Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            wget \
            tar \
            unzip \
            zip \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            dwarves \
            git

      - name: Download & Extract LLVM 19.1.0
        run: |
          # 下载LLVM 19.1.0工具链
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz -O llvm-19.1.0.tar.xz
          # 解压到/usr/local/llvm
          sudo tar -xf llvm-19.1.0.tar.xz -C /usr/local/
          sudo ln -s /usr/local/LLVM-19.1.0-Linux-X64 /usr/local/llvm
          # 添加LLVM到环境变量
          echo "PATH=/usr/local/llvm/bin:$PATH" >> $GITHUB_ENV
          # 安装LLVM的arm32编译依赖（clang交叉编译arm32需libclang-rt）
          sudo apt install -y libclang-rt-19-dev-armhf-cross

      - name: Set Environment Variables (LLVM)
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabihf-" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "KERNEL_PATH=$(pwd)/kernel" >> $GITHUB_ENV

      - name: Build Kernel (LLVM + Skip DTBO)
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          # 加载默认配置
          make lavender_defconfig
          # 用LLVM编译内核，跳过DTBO
          make -j$(nproc) Image.gz-dtb NO_DTBO=1 \
            CC=clang \
            CXX=clang++ \
            CLANG_TRIPLE=aarch64-linux-gnu-
          # 验证产物
          ls -l arch/arm64/boot/Image.gz-dtb

      - name: Clone AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel
          cd anykernel
          sed -i 's/device.name1=/device.name1=lavender/' anykernel.sh
          sed -i 's/device.name2=/device.name2=Redmi Note 7/' anykernel.sh
          sed -i 's/device.name3=/device.name3=Redmi Note 7 Pro/' anykernel.sh
          sed -i 's/device.name4=/device.name4=Redmi Note 7S/' anykernel.sh

      - name: Pack Flashable Zip
        run: |
          cp ${{ env.KERNEL_PATH }}/arch/arm64/boot/Image.gz-dtb anykernel/
          cd anykernel
          zip -r9 Lavender-Kernel-LLVM19-$(date +%Y%m%d-%H%M).zip * -x .git* README.md *.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lavender-Kernel-LLVM19-Build
          path: anykernel/Lavender-Kernel-LLVM19-*.zip
          retention-days: 7
