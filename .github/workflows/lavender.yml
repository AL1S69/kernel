name: Build Lavender 4.4 Kernel (BPF+Custom Name)
on:
  push:
    branches: [main]
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-20.04 # 适配4.4内核编译
    steps:
      - name: 1. 拉取指定源码（projects-nexus/lavender）
        uses: actions/checkout@v4
        with:
          repository: projects-nexus/nexus_kernel_xiaomi_lavender
          ref: master
          path: kernel
          fetch-depth: 1

      - name: 2. 拉取你的补丁仓库（含kernel_4.4.patch）
        uses: actions/checkout@v4
        with:
          repository: AL1S69/kernel # 你的仓库
          ref: main
          path: patch_repo
          fetch-depth: 1

      - name: 3. 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi make git wget zip unzip patch bc bison flex libssl-dev libelf-dev libncurses5-dev

      - name: 4. 合并BPF补丁
        run: |
          cd kernel
          patch -p1 < ../patch_repo/kernel_4.4.patch # 应用你的BPF补丁
          echo "✅ BPF补丁合并完成"

      - name: 5. 加载lavender配置并开启BPF项
        run: |
          cd kernel
          # 加载lavender默认配置
          make ARCH=arm64 lavender_defconfig
          # 直接通过scripts/config开启指定BPF配置（替代EOF）
          scripts/config --enable CONFIG_CGROUP_BPF
          scripts/config --enable CONFIG_BPF
          scripts/config --enable CONFIG_BPF_SYSCALL
          scripts/config --enable CONFIG_BPF_JIT_ALWAYS_ON
          scripts/config --enable CONFIG_NETFILTER_XT_MATCH_BPF
          scripts/config --enable CONFIG_NET_CLS_BPF
          scripts/config --enable CONFIG_BPF_JIT
          scripts/config --enable CONFIG_HAVE_EBPF_JIT
          # 保存配置
          make ARCH=arm64 olddefconfig
          echo "✅ BPF所有配置项已开启"

      - name: 6. 修改内核名（zako～kernel）
        run: |
          cd kernel
          # 改LOCALVERSION（永久生效）
          scripts/config --set-str LOCALVERSION "-zako～kernel"
          make ARCH=arm64 olddefconfig
          # Makefile兜底
          echo 'LOCALVERSION := -zako～kernel' >> Makefile
          # 改AnyKernel3显示名（如有）
          [ -d "AnyKernel3" ] && sed -i 's/^kernel.string=.*/kernel.string=zako～kernel/' AnyKernel3/anykernel.sh
          echo "✅ 内核名修改为zako～kernel"

      - name: 7. 配置编译器并编译内核
        run: |
          cd kernel
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=gcc
          export HOSTCC=gcc
          export ARCH=arm64
          # 编译（禁用警告转错，适配4.4内核）
          make -j$(nproc) KCFLAGS=-Wno-error KCFLAGS+=-Wno-dangling-pointer
          echo "✅ 内核编译完成"

      - name: 8. 打包可刷内核包
        run: |
          cd kernel
          # 检查镜像和AnyKernel3
          if [ -f "arch/arm64/boot/Image.gz-dtb" ] && [ -d "AnyKernel3" ]; then
            cp arch/arm64/boot/Image.gz-dtb AnyKernel3/
            cd AnyKernel3
            rm -rf *.zip
            zip -r9 zako～kernel-BPF-lavender-4.4.zip * -x .git* *.md
            echo "✅ 内核包打包完成"
          else
            echo "⚠️ 跳过打包：缺失Image.gz-dtb或AnyKernel3"
          fi

      - name: 9. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: zako～kernel-BPF-lavender-4.4
          path: kernel/AnyKernel3/zako～kernel-BPF-lavender-4.4.zip
          if-no-files-found: warn
