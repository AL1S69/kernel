name: Build & Pack Lavender 4.4 Kernel (Akitlove-Tools+AnyKernel3-Aonly)
on: workflow_dispatch

jobs:
  build_and_pack:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 安装基础依赖
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends \
          git make bison flex bc libssl1.1 libelf-dev python3 curl liblz4-tool zstd xz-utils libncurses5-dev patch zip
          sudo apt clean

      - name: 2. 克隆lavender 4.4内核源码
        run: |
          git clone -b main --depth=1 https://github.com/jsdizkcksv/android_kernel_xiaomi_sdm660.git lavender-44
          cd lavender-44
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          git submodule update --init --depth=1 || true

      - name: 3. 缓存Akitlove工具链
        id: cache-tools
        uses: actions/cache@v3
        with:
          path: ./android-kernel-tools
          key: akitlove-tools-lavender44

      - name: 4. 克隆Akitlove工具链
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/Akitlove/android-kernel-tools.git
          echo "TOOLCHAIN_DIR=$(pwd)/android-kernel-tools" >> $GITHUB_ENV

      - name: 5. 内核配置（BPF+兼容配置）
        run: |
          cd $KERNEL_DIR
          make O=out ARCH=arm64 lavender_defconfig
          # BPF核心配置
          echo "CONFIG_BPF=y" >> out/.config
          echo "CONFIG_BPF_SYSCALL=y" >> out/.config
          echo "CONFIG_BPF_JIT=y" >> out/.config
          echo "CONFIG_NET_CLS_BPF=y" >> out/.config
          echo "CONFIG_NET_ACT_BPF=y" >> out/.config
          # 4.4内核必配，避坑
          echo "CONFIG_MODULES=y" >> out/.config
          echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
          echo "CONFIG_COMPAT_VDSO=n" >> out/.config
          echo "CONFIG_LTO=n" >> out/.config
          echo "CONFIG_DEBUG_SECTION_MISMATCH=n" >> out/.config
          echo "CONFIG_WERROR=n" >> out/.config
          yes "" | make O=out ARCH=arm64 olddefconfig
          grep -E "CONFIG_BPF=y" out/.config || { echo "BPF配置失效" && exit 1; }

      - name: 6. 编译内核（Akitlove工具链适配）
        run: |
          cd $KERNEL_DIR
          export ARCH=arm64
          export SUBARCH=arm64
          # 指向Akitlove工具链核心
          export CROSS_COMPILE=$TOOLCHAIN_DIR/gcc/bin/aarch64-elf-
          export CROSS_COMPILE_ARM32=$TOOLCHAIN_DIR/gcc/bin/arm-eabi-
          export CC=$CROSS_COMPILE-gcc
          export LD=$CROSS_COMPILE-ld
          export AR=$CROSS_COMPILE-ar
          export NM=$CROSS_COMPILE-nm
          export OBJCOPY=$CROSS_COMPILE-objcopy
          export OBJDUMP=$CROSS_COMPILE-objdump
          export STRIP=$CROSS_COMPILE-strip
          
          # 4.4内核适配参数，无汇编报错
          export KBUILD_CFLAGS="-fno-pie -no-pie -Wno-error=asm-operand-widths -Wno-error=deprecated-declarations"
          export MAKEFLAGS="-j$(nproc)"
          make -j$(nproc) O=out ARCH=arm64 Image dtbo.img dtbs > build.log 2>&1 || { cat build.log && exit 1; }

      - name: 7. 拉取AnyKernel3(A-only适配)
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel3
          cd anykernel3
          sed -i 's/device.name1=.*/device.name1=lavender/' anykernel.sh
          sed -i 's/block=.*/block=\/dev\/block\/bootdevice\/by-name\/boot/' anykernel.sh
          sed -i 's/is_slot_device=auto/is_slot_device=no/' anykernel.sh
          sed -i 's/skip_dtbo=0/skip_dtbo=1/' anykernel.sh
          echo "ANYKERNEL_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 8. 拷贝产物
        run: |
          cp $KERNEL_DIR/out/arch/arm64/boot/Image $ANYKERNEL_DIR/zImage
          cp $KERNEL_DIR/out/arch/arm64/boot/dtbo.img $ANYKERNEL_DIR/dtbo.img
          cp $KERNEL_DIR/out/arch/arm64/boot/dts/qcom/sdm660-lavender.dtb $ANYKERNEL_DIR/dtb

      - name: 9. 打包刷机包
        run: |
          cd $ANYKERNEL_DIR
          zip -r9 Lavender-4.4-Kernel-Akitlove-Aonly.zip * -x .git* README.md *.sh
          mkdir -p $KERNEL_DIR/final-output
          cp Lavender-4.4-Kernel-Akitlove-Aonly.zip $KERNEL_DIR/final-output/

      - name: 10. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Lavender-Aonly-Kernel-Akitlove
          path: $KERNEL_DIR/final-output/*.zip
          retention-days:14
