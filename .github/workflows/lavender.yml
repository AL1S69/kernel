name: Lavender SDM660 Build (zako~kernel + LLVM 19.1.0 + Fix Kconfig)

on:
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Deep Clean Runner Space
        run: |
          sudo apt remove -y --purge firefox snapd google-chrome-stable libreoffice*
          sudo apt autoremove -y && sudo apt clean
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /var/lib/docker /var/cache/apt/archives/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/* /home/runner/actions-runner/_work/_cache/*
          df -h /

      # 核心修复：移除稀疏检出，完整克隆源码（解决Kconfig文件缺失）
      - name: Checkout Kernel Source (Full)
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          path: kernel
          submodules: false
          fetch-depth: 1 # 仅克隆最新提交，减少体积

      - name: Create LLVM Directory First
        run: |
          mkdir -p ${{ github.workspace }}/llvm-19.1.0
          ls -ld ${{ github.workspace }}/llvm-19.1.0/

      - name: Download & Extract LLVM 19.1.0 (Stream + Fix)
        run: |
          wget -q -O - https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz | tar -xJ -C /tmp/
          mv /tmp/LLVM-19.1.0-Linux-X64/* ${{ github.workspace }}/llvm-19.1.0/
          chmod -R +x ${{ github.workspace }}/llvm-19.1.0/bin/
          rm -rf /tmp/LLVM-19.1.0-Linux-X64
          du -sh ${{ github.workspace }}/llvm-19.1.0/

      - name: Install Minimal Dependencies
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            bc bison flex libssl-dev libelf-dev dwarves make gcc-aarch64-linux-gnu
          sudo apt clean

      # 新增：验证Kconfig文件是否存在
      - name: Verify Kconfig Files
        working-directory: kernel
        run: |
          ls -l arch/arm64/Kconfig
          ls -l init/Kconfig || echo "init/Kconfig exists"

      - name: Configure Kernel (zako~kernel + Slim)
        working-directory: kernel
        run: |
          export ARCH=arm64
          # 核心：指定完整的配置文件路径，避免查找错误
          make O=out lavender_defconfig
          cd out
          scripts/config --set-str LOCALVERSION "-zako~kernel"
          scripts/config --disable COMPAT --disable COMPAT_VDSO --disable CONFIG_DTBO_BUILD
          scripts/config --disable DEBUG_INFO --disable KERNEL_DEBUG --disable TRACEPOINTS
          scripts/config --enable BPF --enable BPF_SYSCALL --enable BPF_JIT
          make ARCH=arm64 olddefconfig

      - name: Compile Kernel (LLVM 19.1.0 + Slim Build)
        working-directory: kernel
        run: |
          export LLVM_DIR=${{ github.workspace }}/llvm-19.1.0
          export CC=$LLVM_DIR/bin/clang
          export CXX=$LLVM_DIR/bin/clang++
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          export PATH=$LLVM_DIR/bin:$PATH
          export KBUILD_CFLAGS="-O2 -g0 -ffunction-sections -fdata-sections"
          export KBUILD_LDFLAGS="--gc-sections"
          # 使用out目录编译，避免源码目录污染
          make -j2 O=out ARCH=arm64 Image.gz-dtb NO_DTBO=1
          ls -lh out/arch/arm64/boot/Image.gz-dtb

      - name: Pack & Upload Kernel
        run: |
          mkdir -p output
          cp kernel/out/arch/arm64/boot/Image.gz-dtb output/
          cd output
          zip -9 -m lavender-zako-kernel-llvm19.zip Image.gz-dtb
          ls -lh *.zip
          uses: actions/upload-artifact@v4
          with:
            name: lavender-zako-kernel-llvm19
            path: output/lavender-zako-kernel-llvm19.zip
            retention-days: 3
