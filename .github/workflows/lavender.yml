name: Lavender SDM660 Build (zako~kernel + LLVM 19.1.0 + Fix Dir)

on:
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Deep Clean Runner Space
        run: |
          sudo apt remove -y --purge firefox snapd google-chrome-stable libreoffice*
          sudo apt autoremove -y && sudo apt clean
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /var/lib/docker /var/cache/apt/archives/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/* /home/runner/actions-runner/_work/_cache/*
          df -h /

      - name: Checkout Kernel Source (Light)
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          path: kernel
          submodules: false
          fetch-depth: 1
          sparse-checkout: |
            arch/arm64
            include
            scripts
            Makefile
            .config

      # 核心修复：提前创建LLVM目标目录
      - name: Create LLVM Directory First
        run: |
          mkdir -p ${{ github.workspace }}/llvm-19.1.0
          ls -ld ${{ github.workspace }}/llvm-19.1.0/

      # 修复流式解压指令，确保文件移动正确
      - name: Download & Extract LLVM 19.1.0 (Stream + Fix)
        run: |
          # 流式解压到临时目录
          wget -q -O - https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz | tar -xJ -C /tmp/
          # 移动解压后的文件到提前创建的目录
          mv /tmp/LLVM-19.1.0-Linux-X64/* ${{ github.workspace }}/llvm-19.1.0/
          # 赋予执行权限
          chmod -R +x ${{ github.workspace }}/llvm-19.1.0/bin/
          # 删除临时文件
          rm -rf /tmp/LLVM-19.1.0-Linux-X64
          du -sh ${{ github.workspace }}/llvm-19.1.0/

      - name: Install Minimal Dependencies
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            bc bison flex libssl-dev libelf-dev dwarves make gcc-aarch64-linux-gnu
          sudo apt clean

      - name: Configure Kernel (zako~kernel + Slim)
        working-directory: kernel
        run: |
          export ARCH=arm64
          make lavender_defconfig
          scripts/config --set-str LOCALVERSION "-zako~kernel"
          scripts/config --disable COMPAT --disable COMPAT_VDSO --disable CONFIG_DTBO_BUILD
          scripts/config --disable DEBUG_INFO --disable KERNEL_DEBUG --disable TRACEPOINTS
          scripts/config --enable BPF --enable BPF_SYSCALL --enable BPF_JIT
          make ARCH=arm64 olddefconfig

      - name: Compile Kernel (LLVM 19.1.0 + Slim Build)
        working-directory: kernel
        run: |
          export LLVM_DIR=${{ github.workspace }}/llvm-19.1.0
          export CC=$LLVM_DIR/bin/clang
          export CXX=$LLVM_DIR/bin/clang++
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          export PATH=$LLVM_DIR/bin:$PATH
          export KBUILD_CFLAGS="-O2 -g0 -ffunction-sections -fdata-sections"
          export KBUILD_LDFLAGS="--gc-sections"
          make -j2 ARCH=arm64 Image.gz-dtb NO_DTBO=1
          ls -lh arch/arm64/boot/Image.gz-dtb

      - name: Pack & Upload Kernel
        run: |
          mkdir -p output
          cp kernel/arch/arm64/boot/Image.gz-dtb output/
          cd output
          zip -9 -m lavender-zako-kernel-llvm19.zip Image.gz-dtb
          ls -lh *.zip
          uses: actions/upload-artifact@v4
          with:
            name: lavender-zako-kernel-llvm19
            path: output/lavender-zako-kernel-llvm19.zip
            retention-days: 3
