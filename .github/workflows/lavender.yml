
name: Lavender SDM660 Build (zako~kernel + LLVM 19.1.0 + Fix Script Path)

on:
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Deep Clean Runner Space
        run: |
          sudo apt remove -y --purge firefox snapd google-chrome-stable libreoffice*
          sudo apt autoremove -y && sudo apt clean
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /var/lib/docker /var/cache/apt/archives/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/* /home/runner/actions-runner/_work/_cache/*
          df -h /

      - name: Checkout Kernel Source (Full)
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          path: kernel
          submodules: false
          fetch-depth: 1

      - name: Create LLVM Directory First
        run: |
          mkdir -p ${{ github.workspace }}/llvm-19.1.0
          ls -ld ${{ github.workspace }}/llvm-19.1.0/

      - name: Download & Extract LLVM 19.1.0 (Stream + Fix)
        run: |
          wget -q -O - https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz | tar -xJ -C /tmp/
          mv /tmp/LLVM-19.1.0-Linux-X64/* ${{ github.workspace }}/llvm-19.1.0/
          chmod -R +x ${{ github.workspace }}/llvm-19.1.0/bin/
          rm -rf /tmp/LLVM-19.1.0-Linux-X64
          du -sh ${{ github.workspace }}/llvm-19.1.0/

      - name: Install Minimal Dependencies
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            bc bison flex libssl-dev libelf-dev dwarves make gcc-aarch64-linux-gnu
          sudo apt clean

      - name: Verify Kconfig & Script Files
        working-directory: kernel
        run: |
          ls -l arch/arm64/Kconfig init/Kconfig
          ls -l scripts/config || echo "scripts/config exists"

      # 核心修复：在源码根目录执行config脚本，指定out目录的.config文件
      - name: Configure Kernel (zako~kernel + Slim + Fix Path)
        working-directory: kernel
        run: |
          export ARCH=arm64
          # 1. 生成out目录的.config文件
          make O=out lavender_defconfig
          # 2. 用源码根目录的scripts/config修改out目录的配置，指定--file参数
          scripts/config --file out/.config --set-str LOCALVERSION "-zako~kernel"
          scripts/config --file out/.config --disable COMPAT
          scripts/config --file out/.config --disable COMPAT_VDSO
          scripts/config --file out/.config --disable CONFIG_DTBO_BUILD
          scripts/config --file out/.config --disable DEBUG_INFO
          scripts/config --file out/.config --disable KERNEL_DEBUG
          scripts/config --file out/.config --disable TRACEPOINTS
          scripts/config --file out/.config --enable BPF
          scripts/config --file out/.config --enable BPF_SYSCALL
          scripts/config --file out/.config --enable BPF_JIT
          # 3. 应用配置修改
          make O=out ARCH=arm64 olddefconfig

      - name: Compile Kernel (LLVM 19.1.0 + Slim Build)
        working-directory: kernel
        run: |
          export LLVM_DIR=${{ github.workspace }}/llvm-19.1.0
          export CC=$LLVM_DIR/bin/clang
          export CXX=$LLVM_DIR/bin/clang++
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          export PATH=$LLVM_DIR/bin:$PATH
          export KBUILD_CFLAGS="-O2 -g0 -ffunction-sections -fdata-sections"
          export KBUILD_LDFLAGS="--gc-sections"
          make -j2 O=out ARCH=arm64 Image.gz-dtb NO_DTBO=1
          ls -lh out/arch/arm64/boot/Image.gz-dtb

      - name: Pack & Upload Kernel
        run: |
          mkdir -p output
          cp kernel/out/arch/arm64/boot/Image.gz-dtb output/
          cd output
          zip -9 -m lavender-zako-kernel-llvm19.zip Image.gz-dtb
          ls -lh *.zip
          uses: actions/upload-artifact@v4
          with:
            name: lavender-zako-kernel-llvm19
            path: output/lavender-zako-kernel-llvm19.zip
            retention-days: 3
