name: Lavender Kernel Build (Skip DTBO)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发编译

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          path: kernel
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            make \
            libssl-dev \
            bc \
            bison \
            flex \
            libelf-dev \
            dwarves \
            git \
            zip \
            unzip \
            wget

      - name: Set Environment Variables
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "KERNEL_PATH=$(pwd)/kernel" >> $GITHUB_ENV

      - name: Build Kernel (Skip DTBO)
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          # 加载默认配置
          make lavender_defconfig
          # 编译内核主体，NO_DTBO=1跳过DTBO构建
          make -j$(nproc) Image.gz-dtb NO_DTBO=1
          # 验证编译产物
          ls -l arch/arm64/boot/Image.gz-dtb

      - name: Clone AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel
          cd anykernel
          # 适配lavender设备信息（可根据实际需求修改）
          sed -i 's/device.name1=/device.name1=lavender/' anykernel.sh
          sed -i 's/device.name2=/device.name2=Redmi Note 7/' anykernel.sh

      - name: Pack Flashable Zip
        run: |
          # 复制内核产物到AnyKernel3目录
          cp ${{ env.KERNEL_PATH }}/arch/arm64/boot/Image.gz-dtb anykernel/
          # 打包刷入包
          cd anykernel
          zip -r9 Lavender-Kernel-$(date +%Y%m%d).zip * -x .git* README.md *.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lavender-Kernel-Build
          path: anykernel/Lavender-Kernel-*.zip
          retention-days: 7 # 产物保留7天
