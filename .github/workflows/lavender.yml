
name: Lavender SDM660 Kernel Build (zako~kernel + LLVM 19.1.0 + No Warnings)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout SDM660 Kernel Source
        uses: actions/checkout@v4
        with:
          repository: jsdizkcksv/android_kernel_xiaomi_sdm660
          submodules: recursive
          fetch-depth: 0

      - name: Cache Kernel Build Artifacts
        uses: actions/cache@v3
        with:
          path: |
            ${{ github.workspace }}/out
            ${{ github.workspace }}/.config
            ${{ github.workspace }}/include/generated
          key: kernel-build-${{ github.sha }}
          restore-keys: |
            kernel-build-

      - name: Cache LLVM 19.1.0 Toolchain
        id: cache_llvm
        uses: actions/cache@v3
        with:
          path: llvm-19.1.0
          key: llvm-19.1.0-linux-x64-2025

      - name: Download & Extract LLVM 19.1.0
        if: steps.cache_llvm.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-Linux-X64.tar.xz -O llvm-19.1.0.tar.xz
          tar -xf llvm-19.1.0.tar.xz
          mv LLVM-19.1.0-Linux-X64 llvm-19.1.0
          chmod -R +x llvm-19.1.0/bin/*

      - name: Add Swap Space
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Install Full Dependencies
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            bc bison flex libssl-dev libelf-dev dwarves git zip unzip wget make \
            gcc-aarch64-linux-gnu lld-19 binutils-aarch64-linux-gnu
          sudo apt clean
          sudo ln -s /usr/bin/lld-19 /usr/bin/ld.lld

      - name: Define Absolute Paths
        run: |
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          echo "LLVM_DIR=$(pwd)/llvm-19.1.0" >> $GITHUB_ENV

      - name: Configure Kernel (zako~kernel + Disable Warnings)
        working-directory: ${{ env.KERNEL_DIR }}
        run: |
          export ARCH=arm64
          make lavender_defconfig
          # 设置自定义内核名
          scripts/config --set-str LOCALVERSION "-zako~kernel"
          # 关闭功能相关配置
          scripts/config --disable COMPAT
          scripts/config --disable COMPAT_VDSO
          scripts/config --disable LDFLAGS_FIX_CORTEX_A53_843419
          scripts/config --disable CONFIG_DTBO_BUILD
          scripts/config --disable CC_STACKPROTECTOR_STRONG
          scripts/config --enable CC_STACKPROTECTOR_BASIC
          scripts/config --enable BPF --enable BPF_SYSCALL --enable BPF_JIT
          # 核心：关闭内核编译警告（仅保留错误）
          scripts/config --disable WARN_UNUSED_RESULT
          scripts/config --disable WARN_DEPRECATED
          scripts/config --set-str CC_FLAGS_ERROR_ON_WARNING "-Werror" # 可选：将警告转为错误快速定位
          make ARCH=arm64 olddefconfig
          grep -E "LOCALVERSION|WARN_" .config

      - name: Compile Kernel (LLVM 19.1.0 + Filter Warnings)
        working-directory: ${{ env.KERNEL_DIR }}
        run: |
          export CC=${{ env.LLVM_DIR }}/bin/clang
          export CXX=${{ env.LLVM_DIR }}/bin/clang++
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          export PATH=${{ env.LLVM_DIR }}/bin:$PATH
          # LLVM编译选项：屏蔽冗余警告
          export KCFLAGS="-w -Wno-deprecated-declarations -Wno-unused-parameter -Wno-pointer-sign"
          export KBUILD_CFLAGS="-w"
          export KBUILD_CXXFLAGS="-w"
          # 编译并过滤警告（仅显示错误）
          make -j4 ARCH=arm64 Image.gz-dtb NO_DTBO=1 DTBO_IMG= \
            CC=$CC CXX=$CXX CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE \
            KCFLAGS="$KCFLAGS" KBUILD_CFLAGS="$KBUILD_CFLAGS" KBUILD_CXXFLAGS="$KBUILD_CXXFLAGS" \
            2>&1 | grep -E "error:|Error:|ERROR:" # 仅输出错误信息
          # 验证产物
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            ls -l arch/arm64/boot/Image.gz-dtb
          else
            echo "编译失败，查看完整日志"
            exit 1
          fi

      - name: Clone AnyKernel3 for Lavender
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel
          cd anykernel
          sed -i "s/device.name1=/device.name1=lavender/" anykernel.sh
          sed -i "s/device.name2=/device.name2=Redmi Note 7/" anykernel.sh
          sed -i "s/kernel.string=/kernel.string=zako~kernel (LLVM 19.1.0)/" anykernel.sh

      - name: Pack Flashable Zip
        run: |
          cp ${{ env.KERNEL_DIR }}/arch/arm64/boot/Image.gz-dtb anykernel/
          cd anykernel
          zip -r9 "Lavender-zako~kernel-LLVM19-$(date +%Y%m%d).zip" * -x .git* README.md *.sh

      - name: Upload Compiled Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Lavender-zako~kernel-LLVM19-Build
          path: anyk
