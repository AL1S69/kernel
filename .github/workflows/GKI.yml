name: Build Zako Kernel (GKI + FastCharge)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: Winkmoon/xinran_kernel_xiaomi_diting.git
          ref: master
          depth: 1
          path: kernel

      - name: Initialization Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib flex bison libssl-dev libncurses5-dev \
          git python3 python3-pip curl wget rsync zip unzip kmod

      - name: Download Toolchain (clang-r547379)
        run: |
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          
          # 下载指定工具链
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz
          tar -xzf clang-r547379.tar.gz
          rm clang-r547379.tar.gz
          
          # 下载 GCC 4.9 作为辅助
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/master.tar.gz -O gcc.tar.gz
          tar -xzf gcc.tar.gz
          rm gcc.tar.gz

      - name: Integrate SukiSU-Ultra
        run: |
          cd ${{ github.workspace }}/kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          echo "SukiSU setup completed."

      - name: Fix C99 Syntax Error
        run: |
          cd ${{ github.workspace }}/kernel
          if [ -f "drivers/kernelsu/throne_tracker.c" ]; then
            echo "Patching throne_tracker.c..."
            sed -i 's/for (char \*line = buf, \*next; line; line = next) {/char *line = buf, *next; for (; line; line = next) {/' drivers/kernelsu/throne_tracker.c
          fi

      - name: Modify Kernel Name & Fast Charge (关键步骤)
        run: |
          cd ${{ github.workspace }}/kernel
          
          ##############################################################################
          # 1. 修改内核版本名: -zako~kernel
          ##############################################################################
          # 方法 A: 修改 Makefile (推荐，最直接)
          echo 'EXTRAVERSION = -zako~kernel' >> Makefile
          # 方法 B: 或者在编译命令中通过 LOCALVERSION 指定 (下面的编译步骤也加了)
          
          ##############################################################################
          # 2. 加入快充支持 (针对小米 Diting 平板硬件)
          # 注意：Diting (Xiaomi Pad 6/6Pro等) 通常使用 MAX77759 充电芯片 + AXP813 电源管理
          # 我们需要修改驱动中的电流限制值。
          ##############################################################################
          
          # --- 策略 A: 修改 MAX77759 充电芯片驱动 (通用安卓平板方案) ---
          # 文件路径可能为 drivers/power/supply/max77759_charger.c
          # 将最大电流限制 (max_current) 从默认值 (如 3000000uA) 修改为更高 (如 5000000uA)
          # 同时修改输入电流限制 (input_current_limit)
          if [ -f "drivers/power/supply/max77759_charger.c" ]; then
            echo "Patching MAX77759 Charger for Fast Charge..."
            # 修改 max_current (搜索类似 .max_current = 3000000 的行)
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 5000000/' drivers/power/supply/max77759_charger.c
            # 修改 input_current_limit
            sed -i 's/\.input_current_limit\s*=\s*[0-9]*/.input_current_limit = 5000000/' drivers/power/supply/max77759_charger.c
            # 修改恒压充电电流 (iccv)
            sed -i 's/\.iccv\s*=\s*[0-9]*/.iccv = 5000000/' drivers/power/supply/max77759_charger.c
          fi

          # --- 策略 B: 修改 AXP813 电源管理驱动 (如果存在) ---
          # 文件路径可能为 drivers/power/axp/axp813.c
          if [ -f "drivers/power/axp/axp813.c" ]; then
            echo "Patching AXP813 for Fast Charge..."
            # 这里假设修改充电电流配置表，将 3000mA 改为 4500mA 或更高
            # 注意：具体数值需根据硬件安全范围调整，这里使用较大值示例
            sed -i 's/3000000/4500000/g' drivers/power/axp/axp813.c
          fi

          # --- 策略 C: 修改 Richtek RT9467 (部分 Diting 变体可能用这个) ---
          if [ -f "drivers/power/supply/rt9467_charger.c" ]; then
            echo "Patching RT9467 Charger..."
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 4500000/' drivers/power/supply/rt9467_charger.c
          fi
          
          echo "Kernel name and fast charge patches applied."
          ##############################################################################

      - name: Start GKI Compilation
        run: |
          cd ${{ github.workspace }}/kernel
          
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ github.workspace }}/toolchain/bin:$PATH"
          
          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_COMPAT=arm-linux-andr