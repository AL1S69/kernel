name: Build Zako Kernel (GKI + Conservative FastCharge)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # 赋予上传产物的权限

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: Winkmoon/xinran_kernel_xiaomi_diting.git
          ref: master
          depth: 1
          path: kernel

      - name: Initialization Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib flex bison libssl-dev libncurses5-dev \
          git python3 python3-pip curl wget rsync zip unzip kmod

      - name: Download Toolchain (clang-r547379)
        run: |
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          
          # 下载指定工具链
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz
          tar -xzf clang-r547379.tar.gz
          rm clang-r547379.tar.gz
          
          # 下载 GCC 4.9 作为辅助
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/master.tar.gz -O gcc.tar.gz
          tar -xzf gcc.tar.gz
          rm gcc.tar.gz

      - name: Integrate SukiSU-Ultra
        run: |
          cd ${{ github.workspace }}/kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          echo "SukiSU setup completed."

      - name: Fix C99 Syntax Error
        run: |
          cd ${{ github.workspace }}/kernel
          if [ -f "drivers/kernelsu/throne_tracker.c" ]; then
            echo "Patching throne_tracker.c..."
            sed -i 's/for (char \*line = buf, \*next; line; line = next) {/char *line = buf, *next; for (; line; line = next) {/' drivers/kernelsu/throne_tracker.c
          fi

      - name: Modify Kernel Name & Conservative Fast Charge
        run: |
          cd ${{ github.workspace }}/kernel
          
          # 1. 修改内核版本名: -zako~kernel
          echo 'EXTRAVERSION = -zako~kernel' >> Makefile
          
          # 2. 保守快充配置（基于小米Diting硬件安全阈值，默认3A→3.6A）
          # MAX77759 充电芯片：3600000uA = 3.6A（原装充电器常见安全上限）
          if [ -f "drivers/power/supply/max77759_charger.c" ]; then
            echo "Patching MAX77759 for Conservative Fast Charge..."
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 3600000/' drivers/power/supply/max77759_charger.c
            sed -i 's/\.input_current_limit\s*=\s*[0-9]*/.input_current_limit = 3600000/' drivers/power/supply/max77759_charger.c
            sed -i 's/\.iccv\s*=\s*[0-9]*/.iccv = 3200000/' drivers/power/supply/max77759_charger.c # 恒压阶段降为3.2A
          fi

          # AXP813 电源管理：3300000uA = 3.3A
          if [ -f "drivers/power/axp/axp813.c" ]; then
            echo "Patching AXP813 for Conservative Fast Charge..."
            sed -i 's/3000000/3300000/g' drivers/power/axp/axp813.c
          fi

          # RT9467 充电芯片：3500000uA = 3.5A
          if [ -f "drivers/power/supply/rt9467_charger.c" ]; then
            echo "Patching RT9467 for Conservative Fast Charge..."
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 3500000/' drivers/power/supply/rt9467_charger.c
          fi
          
          echo "Kernel name and conservative fast charge patches applied."

      - name: Start GKI Compilation
        run: |
          cd ${{ github.workspace }}/kernel
          
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ github.workspace }}/toolchain/bin:$PATH"
          
          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
          
          # 清理
          make clean && make mrproper
          
          # 加载 GKI 配置
          make gki_defconfig
          
          # 编译内核
          make -j$(nproc) LOCALVERSION=-zako~kernel Image.gz
          
          # 检查产物
          if [ -f "arch/arm64/boot/Image.gz" ]; then
            echo "GKI Kernel Build Success!"
            strings arch/arm64/boot/Image.gz | grep "Linux version" | head -n 1
          else
            echo "Build Failed!"
            exit 1
          fi

      - name: Pack into Flashable ZIP
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 -b main anykernel
          
          # 修改 AnyKernel3 标识
          sed -i 's/name1=/name1=Zako Kernel/' anykernel/anykernel.sh
          sed -i 's/version1=/version1=GKI-ConservativeFastCharge/' anykernel/anykernel.sh
          
          cp ${{ github.workspace }}/kernel/arch/arm64/boot/Image.gz anykernel/
          
          # 命名并打包
          VERSION=$(date +%Y%m%d-%H%
