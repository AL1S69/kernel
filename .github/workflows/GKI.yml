name: Build Zako Kernel (GKI + Conservative FastCharge)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: Winkmoon/xinran_kernel_xiaomi_diting.git
          ref: master
          fetch-depth: 1
          path: kernel

      - name: Initialization Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib flex bison libssl-dev libncurses5-dev \
          git python3 python3-pip curl wget rsync zip unzip kmod

      - name: Download Toolchain (clang-r547379 + GCC 4.9)
        run: |
          # 创建工具链目录并分目录存放Clang和GCC
          mkdir -p ${{ github.workspace }}/toolchain/clang
          mkdir -p ${{ github.workspace }}/toolchain/gcc
          
          # 下载并解压Clang r547379
          cd ${{ github.workspace }}/toolchain/clang
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
          tar -xzf clang.tar.gz
          rm clang.tar.gz
          
          # 下载并解压AOSP GCC 4.9 (arm64)
          cd ${{ github.workspace }}/toolchain/gcc
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/master.tar.gz -O gcc.tar.gz
          tar -xzf gcc.tar.gz
          rm gcc.tar.gz
          
          # 验证工具链是否存在
          echo "Clang path: $(ls ${{ github.workspace }}/toolchain/clang/bin/clang)"
          echo "GCC path: $(ls ${{ github.workspace }}/toolchain/gcc/bin/aarch64-linux-android-gcc)"

      - name: Integrate SukiSU-Ultra
        run: |
          # 修正源码路径：kernel/kernel
          cd ${{ github.workspace }}/kernel/kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          echo "SukiSU setup completed."

      - name: Fix C99 Syntax Error
        run: |
          cd ${{ github.workspace }}/kernel/kernel
          if [ -f "drivers/kernelsu/throne_tracker.c" ]; then
            echo "Patching throne_tracker.c..."
            sed -i 's/for (char \*line = buf, \*next; line; line = next) {/char *line = buf, *next; for (; line; line = next) {/' drivers/kernelsu/throne_tracker.c
          fi

      - name: Modify Kernel Name & Conservative Fast Charge
        run: |
          cd ${{ github.workspace }}/kernel/kernel
          
          # 修改内核版本名: -zako~kernel
          echo 'EXTRAVERSION = -zako~kernel' >> Makefile
          
          # 保守快充配置（3.6A/3.3A/3.5A安全阈值）
          if [ -f "drivers/power/supply/max77759_charger.c" ]; then
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 3600000/' drivers/power/supply/max77759_charger.c
            sed -i 's/\.input_current_limit\s*=\s*[0-9]*/.input_current_limit = 3600000/' drivers/power/supply/max77759_charger.c
            sed -i 's/\.iccv\s*=\s*[0-9]*/.iccv = 3200000/' drivers/power/supply/max77759_charger.c
          fi

          if [ -f "drivers/power/axp/axp813.c" ]; then
            sed -i 's/3000000/3300000/g' drivers/power/axp/axp813.c
          fi

          if [ -f "drivers/power/supply/rt9467_charger.c" ]; then
            sed -i 's/\.max_current\s*=\s*[0-9]*/.max_current = 3500000/' drivers/power/supply/rt9467_charger.c
          fi
          
          echo "Kernel name and conservative fast charge patches applied."

      - name: Start GKI Compilation
        run: |
          cd ${{ github.workspace }}/kernel/kernel
          
          # 配置工具链路径（同时加入Clang和GCC的bin目录）
          export PATH="${{ github.workspace }}/toolchain/clang/bin:${{ github.workspace }}/toolchain/gcc/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          
          # 编译器配置
          export CC=clang
          export CXX=clang++
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
          
          # 清理旧产物
          make clean && make mrproper
          
          # 加载GKI配置
          make gki_defconfig
          
          # 编译内核（指定内核名）
          make -j$(nproc) LOCALVERSION=-zako~kernel Image.gz
          
          # 检查产物是否生成
          if [ -f "arch/arm64/boot/Image.gz" ]; then
            echo "GKI Kernel Build Success!"
            strings arch/arm64/boot/Image.gz | grep "Linux version" | head -n 1
          else
            echo "Build Failed!"
            exit 1
          fi

      - name: Pack into Flashable ZIP
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 -b main anykernel
          
          # 修改AnyKernel3标识
          sed -i 's/name1=/name1=Zako Kernel/' anykernel/anykernel.sh
          
