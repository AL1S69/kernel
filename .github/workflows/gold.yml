name: Build Lavender Kernel (AK3 Pack)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: 拉取内核源码到根目录
        uses: actions/checkout@v4
        with:
          repository: jsdizkcks/android_kernel_xiaomi_sdm660.git
          path: .  # 下载到工作流根目录，取消子目录嵌套
          submodules: recursive

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu make bc bison flex libssl-dev libelf-dev git python3 zip unzip

      - name: 配置内核（自定义名称+开启BPF）
        run: |
          # 根目录直接执行，无需cd kernel
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- lavender_defconfig
          echo "CONFIG_BPF_JIT_ALWAYS_ON=y" >> .config
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
          sed -i 's/^LOCALVERSION=.*/LOCALVERSION=-zako~kernel/' Makefile

      - name: 编译内核
        run: |
          # 根目录编译内核
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- Image.gz-dtb
          ls -l arch/arm64/boot/Image.gz-dtb  # 验证产物

      - name: 拉取AK3打包工具
        run: |
          git clone https://github.com/ak3rdparty/AnyKernel3.git -b lavender anykernel3
          # 根目录的产物复制到AK3目录
          cp arch/arm64/boot/Image.gz-dtb anykernel3/Image.gz-dtb

      - name: 打包AK3刷机包
        run: |
          cd anykernel3
          zip -r9 zako-kernel-lavender.zip * -x .git* README.md *.sh

      - name: 上传AK3刷机包
        uses: actions/upload-artifact@v4
        with:
          name: zako-kernel-lavender-AK3
          path: anykernel3/zako-kernel-lavender.zip
